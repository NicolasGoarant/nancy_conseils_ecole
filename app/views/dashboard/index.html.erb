<h1>Tableau de bord</h1>

<% if current_user %>
  <div class="welcome-message">
    <p>Bienvenue, <%= current_user.full_name %> !</p>
  </div>
  
  <% if current_user.admin? %>
    <section class="dashboard-section">
  <h2>Prochains conseils</h2>
  <% 
    begin
      upcoming_councils = Council.joins(school: :associations)
                            .where(associations: { user_id: current_user.id, active: true })
                            .where('date >= ?', Date.today)
                            .order(date: :asc)
                            .limit(5)
    rescue
      upcoming_councils = []
    end
  %>
  
  <% if upcoming_councils.any? %>
    <div class="council-list">
      <% upcoming_councils.each do |council| %>
        <div class="council-item">
          <div class="council-date">
            <%= council.date.strftime('%d/%m/%Y') %>
          </div>
          <div class="council-details">
            <h3><%= council.title %></h3>
            <p><%= council.school.name %></p>
          </div>
          <div class="council-actions">
            <%= link_to "Voir détails", "#", class: "action-button small" %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="info-message">Aucun conseil à venir.</p>
  <% end %>
</section>
  <% end %>
  
  <% if current_user.official? %>
    <section class="dashboard-section">
      <h2>Mes écoles</h2>
      <% if current_user.associations.where(active: true).any? %>
        <div class="card-grid">
          <% current_user.associations.where(active: true).each do |association| %>
            <div class="dashboard-card">
              <h3><%= association.school.name %></h3>
              <p><%= association.school.address %></p>
              <%= link_to "Voir détails", "#", class: "action-button" %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="info-message">Aucune école associée à votre compte.</p>
      <% end %>
    </section>
    
    <section class="dashboard-section">
  <h2>Mon école</h2>
  <% 
    begin
      school = School.joins(:associations).where(associations: { user_id: current_user.id }).first
    rescue
      school = nil
    end
  %>
  
  <% if school %>
    <div class="dashboard-card large">
      <h3><%= school.name %></h3>
      <p><%= school.address %></p>
      <p><strong>Téléphone :</strong> <%= school.phone %></p>
      <p><strong>Email :</strong> <%= school.email %></p>
      
      <div class="school-actions">
        <%= link_to "Gérer les informations", "#", class: "action-button" %>
        <%= link_to "Gérer les conseils", "#", class: "action-button" %>
      </div>
    </div>
  <% else %>
    <p class="info-message">Aucune école associée à votre compte.</p>
  <% end %>
</section>
  <% end %>
  
  <% if current_user.school? %>
    <section class="dashboard-section">
      <h2>Mon école</h2>
      <% school = School.joins(:associations).where(associations: { user_id: current_user.id }).first rescue nil %>
      
      <% if school %>
        <div class="dashboard-card large">
          <h3><%= school.name %></h3>
          <p><%= school.address %></p>
          <p><strong>Téléphone :</strong> <%= school.phone %></p>
          <p><strong>Email :</strong> <%= school.email %></p>
          
          <div class="school-actions">
            <%= link_to "Gérer les informations", "#", class: "action-button" %>
            <%= link_to "Gérer les conseils", "#", class: "action-button" %>
          </div>
        </div>
      <% else %>
        <p class="info-message">Aucune école associée à votre compte.</p>
      <% end %>
    </section>
  <% end %>
<% else %>
  <p>Veuillez vous <a href="/login">connecter</a> pour accéder au tableau de bord.</p>
<% end %>

<style>
  .welcome-message {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .dashboard-section {
    margin-bottom: 30px;
  }
  
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 15px;
  }
  
  .dashboard-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .dashboard-card.large {
    grid-column: 1 / -1;
  }
  
  .action-button {
    display: inline-block;
    background-color: #c00;
    color: white;
    padding: 8px 15px;
    text-decoration: none;
    border-radius: 4px;
    margin-top: 10px;
  }
  
  .action-button:hover {
    background-color: #a00;
  }
  
  .action-button.small {
    padding: 5px 10px;
    font-size: 0.9em;
  }
  
  .council-list {
    margin-top: 15px;
  }
  
  .council-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
  }
  
  .council-date {
    min-width: 100px;
    text-align: center;
    padding-right: 15px;
    font-weight: bold;
  }
  
  .council-details {
    flex-grow: 1;
  }
  
  .council-details h3 {
    margin: 0 0 5px 0;
  }
  
  .council-details p {
    margin: 0;
    color: #555;
  }
  
  .council-actions {
    min-width: 100px;
    text-align: right;
  }
  
  .info-message {
    background-color: #e9f5fb;
    padding: 15px;
    border-radius: 8px;
    color: #0c5460;
  }
  
  .school-actions {
    margin-top: 15px;
  }
</style>